# 运维（备份 / 升级 / 回滚）

> [< 上一篇：安全基线](07-安全基线（强制项）.md) | [返回目录](README.md) | [下一篇：故障排查 >](09-故障排查.md)

> 文档默认 LiteLLM 版本：**v1.80.11**（更新日期：**2026-01-13**）

## 备份（必须）

- PostgreSQL：每日全量（至少）+ 异机保存
- 配置：`/opt/litellm-server/config/`、反代配置、`.env`（注意权限）

### 备份示例命令（可直接照做）

```bash
set -e
cd /opt/litellm-server

# 让 shell 读取 .env 里的 POSTGRES_USER/POSTGRES_DB 等变量（不会写回磁盘）
set -a
source .env
set +a

# 1) 备份 PostgreSQL（示例：输出到 /opt/backup）
sudo mkdir -p /opt/backup
sudo chmod 700 /opt/backup

TS=$(date +%Y%m%d%H%M%S)
docker compose exec -T postgres pg_dump -U "${POSTGRES_USER}" "${POSTGRES_DB}" > "/opt/backup/litellm_db_${TS}.sql"
gzip -9 "/opt/backup/litellm_db_${TS}.sql"

# 2) 备份配置与 .env（注意权限）
sudo tar -C /opt/litellm-server -czf "/opt/backup/litellm_config_${TS}.tar.gz" config docker-compose.yml .env
sudo chmod 600 "/opt/backup/litellm_config_${TS}.tar.gz"
```

> 强烈建议：把 `/opt/backup` 的产物同步到异机/对象存储，并配置保留策略（例如保留 30 天 + 每月归档）。

## 升级（必须先预生产）

1) 先在预生产验证：接口、指标、WordPress 集成兼容  
2) 生产升级前做 DB 备份（见上）  
3) 明确回滚策略：镜像版本回退 + DB 恢复预案  

### 升级步骤（生产）

```bash
cd /opt/litellm-server

# 1) 修改 .env 中 LITELLM_IMAGE（从 v1.80.11 -> v1.80.xx）
sudo vi .env

# 2) 拉取并重建
docker compose pull
docker compose up -d

# 3) 冒烟验证
curl -fsS http://127.0.0.1:24157/health
```

> 如升级涉及数据库 schema 变更，请先查阅你锁定版本的 release notes，并在预生产演练回滚。

## 回滚（建议演练）

回滚顺序建议：

1) **回退镜像版本**（把 `.env` 中 `LITELLM_IMAGE` 改回升级前的版本，例如 `v1.80.11`）  
2) **重建服务**：`docker compose up -d`  
3) **必要时恢复数据库**（如果升级产生不兼容变更）  
4) **验收**：`/health`、核心 `/v1/...`、WordPress iframe `/ui`  

数据库恢复示例（把压缩包解开后导入）：

```bash
set -a
source /opt/litellm-server/.env
set +a

gunzip -c /opt/backup/litellm_db_<TS>.sql.gz | docker compose exec -T postgres psql -U "${POSTGRES_USER}" "${POSTGRES_DB}"
```

