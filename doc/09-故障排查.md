# 故障排查

> [< 上一篇：运维](08-运维（备份-升级-回滚）.md) | [返回目录](README.md)

> 文档默认 LiteLLM 版本：**v1.80.11-stable**（更新日期：**2026-01-13**）

## 1) iframe 无法加载 `/ui`

常见原因：
- WordPress 后台是 **HTTPS**，但 LiteLLM `/ui` 是 **HTTP**（mixed content 被浏览器拦截）
- 反代层返回 `X-Frame-Options: SAMEORIGIN`
- CSP 未允许 WordPress 域名作为 frame-ancestors

处理：
- 确保 LiteLLM 对外入口为 HTTPS（与 WP 后台同协议）
- 使用 `../nginx/litellm.conf` 的思路：`proxy_hide_header X-Frame-Options;` + `Content-Security-Policy: frame-ancestors ...`
- 用下面命令验证响应头（确保 CSP 与 X-Frame-Options 正确）：

```bash
curl -I https://litellm.yourcompany.com/ui/ | egrep -i "content-security-policy|x-frame-options"
```

### 1.1) mixed content：浏览器提示加载了 `http://.../ui/login/`

现象（典型）：

- WordPress 后台为 HTTPS；
- iframe 初始 src 是 `https://litellm.example.com/ui`；
- 但 Network 里出现：`https://litellm.example.com/ui/login` 返回 `307/308`，并带 `Location: http://litellm.example.com/ui/login/`；
- 浏览器报：mixed content（HTTPS 页面嵌入了 HTTP frame）。

根因：

- `/ui/login`（无尾斜杠）与 `/ui/login/` 是不同 URL；后端常用 `307/308` 做“补尾斜杠”规范化。
- 在多层反代/未正确设置 forwarded headers 时，该跳转可能生成 `http://...` 绝对地址。

处理（推荐：Nginx 层兜底，避免后端 307 生成 http）：

```nginx
location = /ui/login { return 308 /ui/login/; }
location /ui/ {
  proxy_set_header X-Forwarded-Proto https;
  proxy_set_header X-Forwarded-Port 443;
  proxy_set_header X-Forwarded-Host $host;
  proxy_redirect http:// https://;
}
```

验证（看到任何 `Location: http://...` 都未修复）：

```bash
curl -sSI https://litellm.example.com/ui/login | egrep -i '^(HTTP/|location:)'
```

### 1.2) redirected you too many times（重定向死循环）

根因（最常见）：

- 写成了前缀匹配：`location /ui/login { return 308 /ui/login/; }`
- 因为 `/ui/login/` 也会命中 `/ui/login`，导致 `/ui/login/` 反复 308 到自己。

修复：

```nginx
location = /ui/login { return 308 /ui/login/; }
```

## 2) `401 Unauthorized`

常见原因：
- Key 不正确（填错/过期/被吊销/被 block）
- 访问的是管理接口（如 `/key/*`、`/api/*`），但你提供的 key 权限不够（某些版本可能只允许 master key）
- Authorization header 格式不正确（应为 `Authorization: Bearer <key>`）

处理建议：
- 优先确认你调用的是哪类接口：
  - **业务调用**：`/v1/...`（给业务方使用）
  - **管理面**：`/key/*`、`/api/*`、`/ui/`（建议仅 VPN/堡垒机/白名单访问）
- 如果是 WordPress 插件侧报 401：
  - 确认 `wp-config.php` 注入的 `LITELLM_SERVICE_KEY` 与 `/opt/litellm-server/service-key.txt` 一致
  - 如果你发现管理接口必须用 master key：建议改为“在 iframe 的 LiteLLM UI 内做 key 管理”，或引入一个内部管理服务代持 master key（不要把 master key 暴露给浏览器/不要落库）

## 3) Nginx 反代 502/504

常见原因：

- LiteLLM 容器未启动或持续重启
- 反代 upstream 写错（应为 `http://127.0.0.1:24157`）
- 端口冲突/未按预期绑定回环

处理建议：

```bash
cd /opt/litellm-server
docker compose ps
docker compose logs -f litellm
curl -fsS http://127.0.0.1:24157/health/liveliness
```
